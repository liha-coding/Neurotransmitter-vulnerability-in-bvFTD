%% This script can be used as input to the following adjusted function 'JuSpace_noGUI': (originally from: https://github.com/juryxy/JuSpace)
%% This script will additionally retrieve the main output from the results

% name of atlas file in JuSpace atlas directory
% asymmetric atlas version: 'm_labels_Neuromorphometrics.nii'
% symmetric atlas version: 'm_labels_Neuromorphometrics_symmetric.nii')
atlas = 'm_labels_Neuromorphometrics.nii';

% index of PET images in JuSpace PETatlas directory
PET_list = [1,2,3,4,5];

% output directory
dir_save = '/YOUR/SAVING/DIRECTORY';

% a name associated with your output files (e.g. 'FTDvsHC')
name_save = 'YourFileName';

% the number of permutations for exact p-value computation
Nperm = 10000;

% settings for JuSpace toolbox
% option(1): 1 --> es between, 2 --> es within, 3 --> mean list 1,
%            4 --> list 1 each, 5 --> ind z-score list 1 to list 2,
%            6 --> pair-wise difference list 1 to list 2, 7 --> leave one out from list 1,
%            8 --> list 1 each compares against null distribution of correlation coefficients
% options(2): 1 --> Spearman correlation, 2 --> Pearson correlation, 3 --> multiple linear regresion
% options(3) = 1 --> computing exact p-value
% options(4) = 1 --> adjust for structural correlations (auto-correlations)
% options(5) = 1 --> computing exact spatial p-value
options = [5; 1; 1; 1; 0];

% load image paths for each group (except for options 1, 2, 5 & 6: list2={})
% images should be corrected for confounding variables
list1 = ImagePathsGroup1;
list2 = ImagePathsGroup2;

% JuSpace path
JuSpace_path = '/Path/To/Your/JuSpace/Folder';
addpath(JuSpace_path);

% create output folder in case it doesn't exist
if ~isfolder(dir_save)
    mkdir(dir_save);
end

cd(dir_save);

% run analysis
JuSpace_noGUI(list1,list2,atlas,options,PET_list,dir_save,name_save,Nperm,PET_folder);

% find files from analysis
% indZ for group1 to group2 analysis
files = dir([dir_save, '*indZ*.mat']);
filename = [dir_save, files.name];
% load Fisher's z transformed correlation coefficients
load(filename, 'stats');
% load p-values
load(filename, 'p_exact');

% check for significance of p-values after FDR correction
p_exact_indZ = p_exact';
fdr_p_indZ = FDR(p_exact_indZ, 0.05); % retrieved from https://de.mathworks.com/matlabcentral/fileexchange/71734-fdr-false-discovery-rate

if isempty(fdr_p_indZ)==1
   fdr_p_indZ = "-";
end

% correlation coefficients
z_pat = stats.res_ind;

% data for figure
z_long = reshape(z_pat,[size(z_pat,1)*size(z_pat,2),1]);

long_second = [];
for i = 1:size(z_pat,2)
    long_second = [long_second; i*ones(size(z_pat,1),1)];
end

z_long(:,2) = long_second;

titles = {char("Fisher's z (Spearman rho)"), char("Neurotransmitter")};

% write figure data to excel
xlswrite(fullfile(dir_save,'z_indZ.xlsx'), titles, 'Tabelle1', 'A1:B1');
xlswrite(fullfile(dir_save,'z_indZ.xlsx'), z_long, 'Tabelle1', 'A2');
