clearvars

% image input folder for MENGA_run_own
imagefolder = '/YOUR/IMAGE/FOLDER';
    
% file containing name of genes
genes_file = '/Your/GENES/FILE';

% saving directory for results
out_dir = '/YOUR/SAVING/DIRECTORY';

% either full or short
roi = 'full';+

% MENGA main path
path_MENGA = '/YOUR/MENGA/PATH';

MENGA_run_own(imagefolder,genes_file,out_dir,roi,path_MENGA)

% list files in out_dir (results folder)
aa = dir(out_dir);
dir_sub = {aa(3:end).name}';
    
% the number of genes
genes = 7;

% the number of GABA genes
genes_GABAa = 19;

% the numer of donors (always 6 in Allan brain atlas)
donors = 6;

% number of ROI regions
regions = 169;

% load all GABAa genes
for i = 1:length(dir_sub)
    for j = 1:donors
        filename = string(fullfile(out_dir,dir_sub{i},[char(string(dir_sub{i})),'.mat']);
        load(filename,"gen2don","img2don");
        X{i,j} = gen2don(j).exp;
        Y{i,j} = img2don(j).exp;
    end
end

% select genes to be used
cols_lessGABA = [1:3,23,4,10,13];

for i = 1:length(dir_sub)
    for j = 1:donors
        for k = 1:size(cols_lessGABA,2)
            X_all{i,j}(k,:) = X{i,j}(cols_lessGABA(1,k),:);
        end
    end
end

% correlate imaging and mRNA gene expression
for i = 1:length(dir_sub)
    for j = 1:genes
       for k = 1:donors         
           data_nonan = rmmissing([X_all{i,k}(j,:);Y{i,k}],2);
           r_lessGABA{i,1}(j,k) = corr(data_nonan(1,:)',data_nonan(2,:)','Type','Spearman');    
       end
    end
end

% transform to Fisher's Z
for i = 1:length(dir_sub)
    z_lessGABA{i,1} = fishers_r_to_z(r_lessGABA{i,1}); % from JuSpace toolbox
end

% calculate mean over donors
for i = 1:length(dir_sub)
    z_mean_lessGABA(i,:) =  mean(z_lessGABA{i,1},2)';
end

% significance test
for i = 1:genes
    [h_z_lessGABA(i),p_z_lessGABA(i)] = ttest(z_mean_lessGABA(:,i),0);
end

% calculate mean over participants
z_mean_all_lessGABA = mean(z_mean_lessGABA);

% transform mean to Spearman
r_mean_all_lessGABA = fishers_z_to_r(z_mean_all_lessGABA);

% gene names
gene_names_lessGABA = {'HTR1B';'HTR2A';'DRD2';'SLC6A2';'GABRA1';'GABRB1';'GABRG1'};

% save variables to file
save('/YOUR/RESULTS/DIRECTORY/imaging_genomic_p.mat','p_z_lessGABA');
save('/YOUR/RESULTS/DIRECTORY/imaging_genomic_r_Spearman.mat','r_mean_all_lessGABA');
save('/YOUR/RESULTS/DIRECTORY/imaging_genomic_r_FisherZ.mat','z_mean_all_lessGABA');

% write excel file
titles1 = {'Neurotransmitter','r_mean_fishers_z','r_mean','p_fishers_z'};
xlswrite('/YOUR/RESULTS/DIRECTORY/imaging_genomic_values.xlsx',titles1,'Tabelle1','A1');
xlswrite('/YOUR/RESULTS/DIRECTORY/imaging_genomic_values.xlsx',gene_names_lessGABA,'Tabelle1','A2');
xlswrite('/YOUR/RESULTS/DIRECTORY/imaging_genomic_values.xlsx',z_mean_all_lessGABA','Tabelle1','B2');
xlswrite('/YOUR/RESULTS/DIRECTORY/imaging_genomic_values.xlsx',r_mean_all_lessGABA','Tabelle1','C2');
xlswrite('/YOUR/RESULTS/DIRECTORY/imaging_genomic_values.xlsx',p_z_lessGABA','Tabelle1','D2');

% prepare data for figure

z_mean_long_lessGABA = reshape(z_mean_lessGABA,[],1);

z_mean_long2_lessGABA = [];
for i = 1:genes
    z_mean_long2_lessGABA = [z_mean_long2_lessGABA;i*ones(52,1)]; % n = 52 patients
end

z_mean_long_lessGABA(:,2) = z_mean_long2_lessGABA;

titles = ["Fisher's z (Spearman rho)","Neurotransmitter"];

xlswrite('/YOUR/RESULTS/DIRECTORY/ImagingGenomic_lessGABA.xlsx',titles,'Tabelle1','A1');
xlswrite('/YOUR/RESULTS/DIRECTORY/ImagingGenomic_lessGABA.xlsx',z_mean_long_lessGABA,'Tabelle1','A2');
