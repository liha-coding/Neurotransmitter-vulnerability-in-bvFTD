clearvars;

% 1. GABA expressions: calculate Z-score per gene for the 169 regions
% 2. Average Z-Scores
% in file:  MENGA_correlations_univariate
%           3. Correlate averages with imaging data
%           4. Fisher's z-transform correlations to run tests
%           5. Calculate mean over donors

dir_start = 'D:\Server\Projekt 3\MENGA\Results\Results_3mm_ownmask_selectedgenes_correction_age_gender_sitedummy_fullROI\';

aa = dir(dir_start);
dir_sub = {aa(3:end).name}';
genes = 5;
genes_GABAa = 19;
donors = 6;
regions = 169;

% load all GABAa genes
for i = 1:length(dir_sub)
    for j = 1:donors
        filename = string(fullfile(dir_start,dir_sub{i},'/')) + string(dir_sub{i}) + ".mat";
        load(filename,"gen2don","img2don");
        X{i,j} = gen2don(j).exp;
        Y{i,j} = img2don(j).exp;
    end
end

gene_start = find(strcmp(gen2don(1).info.gene_name,'GABRA1'));

gene_names = {'HTR1B';'HTR2A';'DRD2';'SLC6A2';'GABR'};

% calculate Z-Score
for i = 1:length(dir_sub)
    for j = gene_start:(gene_start+genes_GABAa-1)
        for k = 1:donors        
            n = regions;
            X_mean = nanmean(X{i,k}(j,:));
            X_z{i,k}(j-gene_start+1,:) = (X{i,k}(j,:)-X_mean)/n;        
        end        
    end
end

% average GABAa Z-Score
for i = 1:length(dir_sub)
    for j = 1:genes_GABAa
        for k = 1:donors
            for l = 1:regions            
                X_z_averaged{i,k}(1,l) = mean(X_z{i,k}(:,l));                
            end
        end 
    end
end

save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\GABAa_averaged.mat','X_z_averaged');

% add GABAa
for i = 1:length(dir_sub)
    for j = 1:donors       
        X_all{i,j} = X{i,j}([1:3,23],:);
        X_all{i,j}(5,:) = X_z_averaged{i,j};    
    end
end

% correlate
for i = 1:length(dir_sub)
    for j = 1:genes
       for k = 1:donors    
           data_nonan = rmmissing([X_all{i,k}(j,:);Y{i,k}],2);
           r{i,1}(j,k) = corr(data_nonan(1,:)',data_nonan(2,:)','Type','Spearman');    
       end
    end
end

% transform to Fisher's Z
for i = 1:length(dir_sub)
    z{i,1} = fishers_r_to_z(r{i,1});
end

% calculate mean over donors
for i = 1:length(dir_sub)
    z_mean(i,:) =  mean(z{i,1},2)';
end

% significance test
for i = 1:genes
    [h_z(i),p_z(i)] = ttest(z_mean(:,i),0);
end

% calculate mean over participants
z_mean_all = mean(z_mean);

% transform mean to Spearman
r_mean_all = fishers_z_to_r(z_mean_all);

save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_p.mat','p_z');
save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_r_Spearman.mat','r_mean_all');
save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_r_FisherZ.mat','z_mean_all');

titles1 = {'Neurotransmitter','r_mean_fishers_z','r_mean','p_fishers_z'};
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values.xlsx',titles1,'Tabelle1','A1');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values.xlsx',gene_names,'Tabelle1','A2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values.xlsx',z_mean_all','Tabelle1','B2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values.xlsx',r_mean_all','Tabelle1','C2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values.xlsx',p_z','Tabelle1','D2');

% for figure

z_mean_long = reshape(z_mean,[],1);

z_mean_long2 = [];
for i = 1:genes
    z_mean_long2 = [z_mean_long2;i*ones(52,1)];
end

z_mean_long(:,2) = z_mean_long2;

titles = ["Fisher's z (Spearman rho)","Neurotransmitter"];

xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\ImagingGenomic.xlsx',titles,'Tabelle1','A1');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\ImagingGenomic.xlsx',z_mean_long,'Tabelle1','A2');

%% only for GABRA1, GABRB1, GABRG1

clearvars;

% 1. GABA expressions: calculate Z-score per gene for the 169 regions
% 2. Average Z-Scores
% in file:  MENGA_correlations_univariate
%           3. Correlate averages with imaging data
%           4. Fisher's z-transform correlations to run tests
%           5. Calculate mean over donors

dir_start = 'D:\Server\Projekt 3\MENGA\Results\Results_3mm_ownmask_selectedgenes_correction_age_gender_sitedummy_fullROI\';

aa = dir(dir_start);
dir_sub = {aa(3:end).name}';
genes = 7;
donors = 6;
regions = 169;

% load all GABAa genes
for i = 1:length(dir_sub)
    for j = 1:donors
        filename = string(fullfile(dir_start,dir_sub{i},'/')) + string(dir_sub{i}) + ".mat";
        load(filename,"gen2don","img2don");
        X{i,j} = gen2don(j).exp;
        Y{i,j} = img2don(j).exp;
    end
end

cols_lessGABA = [1:3,23,4,10,13];

for i = 1:length(dir_sub)
    for j = 1:donors
        for k = 1:size(cols_lessGABA,2)
            X_all{i,j}(k,:) = X{i,j}(cols_lessGABA(1,k),:);
        end
    end
end

% correlate
for i = 1:length(dir_sub)
    for j = 1:genes
       for k = 1:donors         
           data_nonan = rmmissing([X_all{i,k}(j,:);Y{i,k}],2);
           r_lessGABA{i,1}(j,k) = corr(data_nonan(1,:)',data_nonan(2,:)','Type','Spearman');    
       end
    end
end

% transform to Fisher's Z
for i = 1:length(dir_sub)
    z_lessGABA{i,1} = fishers_r_to_z(r_lessGABA{i,1});
end

% calculate mean over donors
for i = 1:length(dir_sub)
    z_mean_lessGABA(i,:) =  mean(z_lessGABA{i,1},2)';
end

% significance test
for i = 1:genes
    [h_z_lessGABA(i),p_z_lessGABA(i)] = ttest(z_mean_lessGABA(:,i),0);
end

% calculate mean over participants
z_mean_all_lessGABA = mean(z_mean_lessGABA);

% transform mean to Spearman
r_mean_all_lessGABA = fishers_z_to_r(z_mean_all_lessGABA);

gene_names_lessGABA = {'HTR1B';'HTR2A';'DRD2';'SLC6A2';'GABRA1';'GABRB1';'GABRG1'};

save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_p_lessGABA.mat','p_z_lessGABA');
save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_r_Spearman_lessGABA.mat','r_mean_all_lessGABA');
save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_r_FisherZ_lessGABA.mat','z_mean_all_lessGABA');

titles1 = {'Neurotransmitter','r_mean_fishers_z','r_mean','p_fishers_z'};
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_lessGABA.xlsx',titles1,'Tabelle1','A1');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_lessGABA.xlsx',gene_names_lessGABA,'Tabelle1','A2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_lessGABA.xlsx',z_mean_all_lessGABA','Tabelle1','B2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_lessGABA.xlsx',r_mean_all_lessGABA','Tabelle1','C2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_lessGABA.xlsx',p_z_lessGABA','Tabelle1','D2');

% for figure

z_mean_long_lessGABA = reshape(z_mean_lessGABA,[],1);

z_mean_long2_lessGABA = [];
for i = 1:genes
    z_mean_long2_lessGABA = [z_mean_long2_lessGABA;i*ones(52,1)];
end

z_mean_long_lessGABA(:,2) = z_mean_long2_lessGABA;

titles = ["Fisher's z (Spearman rho)","Neurotransmitter"];

xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\ImagingGenomic_lessGABA.xlsx',titles,'Tabelle1','A1');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\ImagingGenomic_lessGABA.xlsx',z_mean_long_lessGABA,'Tabelle1','A2');


%% all GABAa

clearvars;

% 1. GABA expressions: calculate Z-score per gene for the 169 regions
% 2. Average Z-Scores
% in file:  MENGA_correlations_univariate
%           3. Correlate averages with imaging data
%           4. Fisher's z-transform correlations to run tests
%           5. Calculate mean over donors

dir_start = 'D:\Server\Projekt 3\MENGA\Results\Results_3mm_ownmask_selectedgenes_correction_age_gender_sitedummy_fullROI\';

aa = dir(dir_start);
dir_sub = {aa(3:end).name}';
genes = 23;
donors = 6;
regions = 169;

% load all genes
for i = 1:length(dir_sub)
    for j = 1:donors
        filename = string(fullfile(dir_start,dir_sub{i},'/')) + string(dir_sub{i}) + ".mat";
        load(filename,"gen2don","img2don");
        X{i,j} = gen2don(j).exp;
        Y{i,j} = img2don(j).exp;
    end
end

cols_allGABA = [1:3,23,4:22];

for i = 1:length(dir_sub)
    for j = 1:donors
        for k = 1:size(cols_allGABA,2)
            X_all{i,j}(k,:) = X{i,j}(cols_allGABA(1,k),:);
            gene_names_allGABA(1,k) = gen2don(1).info.gene_name(cols_allGABA(1,k),1);
        end
    end
end

% correlate
for i = 1:length(dir_sub)
    for j = 1:genes
       for k = 1:donors         
           data_nonan = rmmissing([X_all{i,k}(j,:);Y{i,k}],2);
           r_allGABA{i,1}(j,k) = corr(data_nonan(1,:)',data_nonan(2,:)','Type','Spearman');    
       end
    end
end

% transform to Fisher's Z
for i = 1:length(dir_sub)
    z_allGABA{i,1} = fishers_r_to_z(r_allGABA{i,1});
end

% calculate mean over donors
for i = 1:length(dir_sub)
    z_mean_allGABA(i,:) =  mean(z_allGABA{i,1},2)';
end

% significance test
for i = 1:genes
    [h_z_allGABA(i),p_z_allGABA(i)] = ttest(z_mean_allGABA(:,i),0);
end

% calculate mean over participants
z_mean_all_allGABA = mean(z_mean_allGABA);

% transform mean to Spearman
r_mean_all_allGABA = fishers_z_to_r(z_mean_all_allGABA);

save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_p_allGABA.mat','p_z_allGABA');
save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_r_Spearman_allGABA.mat','r_mean_all_allGABA');
save('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_r_FisherZ_allGABA.mat','z_mean_all_allGABA');

titles1 = {'Neurotransmitter','r_mean_fishers_z','r_mean','p_fishers_z'};
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_allGABA.xlsx',titles1,'Tabelle1','A1');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_allGABA.xlsx',gene_names_allGABA,'Tabelle1','A2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_allGABA.xlsx',z_mean_all_allGABA','Tabelle1','B2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_allGABA.xlsx',r_mean_all_allGABA','Tabelle1','C2');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\imaging_genomic_values_allGABA.xlsx',p_z_allGABA','Tabelle1','D2');

% for figure

z_mean_long_allGABA = reshape(z_mean_allGABA,[],1);

z_mean_long2_allGABA = [];
for i = 1:genes
    z_mean_long2_allGABA = [z_mean_long2_allGABA;i*ones(52,1)];
end

z_mean_long_allGABA(:,2) = z_mean_long2_allGABA;

titles = ["Fisher's z (Spearman rho)","Neurotransmitter"];

xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\ImagingGenomic_allGABA.xlsx',titles,'Tabelle1','A1');
xlswrite('D:\Server\Projekt 3\MENGA\Results\Correlations\fullROI\ImagingGenomic_allGABA.xlsx',z_mean_long_allGABA,'Tabelle1','A2');
